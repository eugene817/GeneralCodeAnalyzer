
import { __decorate, __param } from '@codingame/monaco-vscode-api/external/tslib/tslib.es6';
import { $, clearNode, append, addDisposableListener, EventType, getWindow, EventHelper } from '@codingame/monaco-vscode-api/vscode/vs/base/browser/dom';
import { StandardMouseEvent } from '@codingame/monaco-vscode-api/vscode/vs/base/browser/mouseEvent';
import { Button } from '@codingame/monaco-vscode-api/vscode/vs/base/browser/ui/button/button';
import { getDefaultHoverDelegate } from '@codingame/monaco-vscode-api/vscode/vs/base/browser/ui/hover/hoverDelegateFactory';
import { Codicon } from '@codingame/monaco-vscode-api/vscode/vs/base/common/codicons';
import { Disposable, DisposableStore } from '@codingame/monaco-vscode-api/vscode/vs/base/common/lifecycle';
import { basename, dirname } from '@codingame/monaco-vscode-api/vscode/vs/base/common/resources';
import { URI } from '@codingame/monaco-vscode-api/vscode/vs/base/common/uri';
import { ILanguageService } from '@codingame/monaco-vscode-api/vscode/vs/editor/common/languages/language.service';
import { IModelService } from '@codingame/monaco-vscode-api/vscode/vs/editor/common/services/model.service';
import { localize } from '@codingame/monaco-vscode-api/vscode/vs/nls';
import { getFlatContextMenuActions } from '@codingame/monaco-vscode-api/vscode/vs/platform/actions/browser/menuEntryActionViewItem';
import { MenuId } from '@codingame/monaco-vscode-api/vscode/vs/platform/actions/common/actions';
import { IMenuService } from '@codingame/monaco-vscode-api/vscode/vs/platform/actions/common/actions.service';
import { IContextKeyService } from '@codingame/monaco-vscode-api/vscode/vs/platform/contextkey/common/contextkey.service';
import { IContextMenuService } from '@codingame/monaco-vscode-api/vscode/vs/platform/contextview/browser/contextView.service';
import { FileKind } from '@codingame/monaco-vscode-api/vscode/vs/platform/files/common/files';
import { IFileService } from '@codingame/monaco-vscode-api/vscode/vs/platform/files/common/files.service';
import { IHoverService } from '@codingame/monaco-vscode-api/vscode/vs/platform/hover/browser/hover.service';
import { ILabelService } from '@codingame/monaco-vscode-api/vscode/vs/platform/label/common/label.service';
import { ResourceContextKey } from '@codingame/monaco-vscode-api/vscode/vs/workbench/common/contextkeys';

let ImplicitContextAttachmentWidget = class ImplicitContextAttachmentWidget extends Disposable {
    constructor(attachment, resourceLabels, contextKeyService, contextMenuService, hoverService, labelService, menuService, fileService, languageService, modelService) {
        super();
        this.attachment = attachment;
        this.resourceLabels = resourceLabels;
        this.contextKeyService = contextKeyService;
        this.contextMenuService = contextMenuService;
        this.hoverService = hoverService;
        this.labelService = labelService;
        this.menuService = menuService;
        this.fileService = fileService;
        this.languageService = languageService;
        this.modelService = modelService;
        this.renderDisposables = this._register(( new DisposableStore()));
        this.domNode = $('.chat-attached-context-attachment.show-file-icons.implicit');
        this.render();
    }
    render() {
        clearNode(this.domNode);
        this.renderDisposables.clear();
        this.domNode.classList.toggle('disabled', !this.attachment.enabled);
        const label = this.resourceLabels.create(this.domNode, { supportIcons: true });
        const file = URI.isUri(this.attachment.value) ? this.attachment.value : this.attachment.value.uri;
        const range = URI.isUri(this.attachment.value) || !this.attachment.isSelection ? undefined : this.attachment.value.range;
        const fileBasename = basename(file);
        const fileDirname = dirname(file);
        const friendlyName = `${fileBasename} ${fileDirname}`;
        const ariaLabel = range ? ( localize(
            4419,
            "Attached file, {0}, line {1} to line {2}",
            friendlyName,
            range.startLineNumber,
            range.endLineNumber
        )) : ( localize(4420, "Attached file, {0}", friendlyName));
        const uriLabel = this.labelService.getUriLabel(file, { relative: true });
        const currentFile = ( localize(4421, "Current file context"));
        const inactive = ( localize(4422, "disabled"));
        const currentFileHint = currentFile + (this.attachment.enabled ? '' : ` (${inactive})`);
        const title = `${currentFileHint}\n${uriLabel}`;
        label.setFile(file, {
            fileKind: FileKind.FILE,
            hidePath: true,
            range,
            title
        });
        this.domNode.ariaLabel = ariaLabel;
        this.domNode.tabIndex = 0;
        const hintElement = append(this.domNode, $('span.chat-implicit-hint', undefined, 'Current file'));
        this._register(this.hoverService.setupManagedHover(getDefaultHoverDelegate('element'), hintElement, title));
        const buttonMsg = this.attachment.enabled ? ( localize(4423, "Disable current file context")) : ( localize(4424, "Enable current file context"));
        const toggleButton = this.renderDisposables.add(( new Button(this.domNode, { supportIcons: true, title: buttonMsg })));
        toggleButton.icon = this.attachment.enabled ? Codicon.eye : Codicon.eyeClosed;
        this.renderDisposables.add(toggleButton.onDidClick((e) => {
            e.stopPropagation();
            this.attachment.enabled = !this.attachment.enabled;
        }));
        const scopedContextKeyService = this.renderDisposables.add(this.contextKeyService.createScoped(this.domNode));
        const resourceContextKey = this.renderDisposables.add(( new ResourceContextKey(
            scopedContextKeyService,
            this.fileService,
            this.languageService,
            this.modelService
        )));
        resourceContextKey.set(file);
        this.renderDisposables.add(addDisposableListener(this.domNode, EventType.CONTEXT_MENU, async (domEvent) => {
            const event = ( new StandardMouseEvent(getWindow(domEvent), domEvent));
            EventHelper.stop(domEvent, true);
            this.contextMenuService.showContextMenu({
                contextKeyService: scopedContextKeyService,
                getAnchor: () => event,
                getActions: () => {
                    const menu = this.menuService.getMenuActions(MenuId.ChatInputResourceAttachmentContext, scopedContextKeyService, { arg: file });
                    return getFlatContextMenuActions(menu);
                },
            });
        }));
    }
};
ImplicitContextAttachmentWidget = ( __decorate([
    ( __param(2, IContextKeyService)),
    ( __param(3, IContextMenuService)),
    ( __param(4, IHoverService)),
    ( __param(5, ILabelService)),
    ( __param(6, IMenuService)),
    ( __param(7, IFileService)),
    ( __param(8, ILanguageService)),
    ( __param(9, IModelService))
], ImplicitContextAttachmentWidget));

export { ImplicitContextAttachmentWidget };
